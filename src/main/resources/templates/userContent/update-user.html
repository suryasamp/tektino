<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="fragments/head :: head"> </head>

    <body class="layout-fixed sidebar-expand-lg bg-body-tertiary" th:data-error="${error}">
        <div class="app-wrapper">
            <!-- =============================== Navbar ================================ -->
            <div th:replace="fragments/header :: header"></div>

            <!-- ============================ START SIDEBAR ============================ -->
            <div th:replace="fragments/sidebar  :: sidebar"></div>

            <!-- =============================== CONTENT =============================== -->
            <main class="app-main">
                <div class="app-content-header">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-6"><h3 class="mb-0">User Update Form</h3></div>
                            <div class="col-sm-6">
                                <ol class="breadcrumb float-sm-end">
                                    <li class="breadcrumb-item"><a href="/user">User</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Users Forms</li>
                                </ol>
                            </div>
                        </div>
                        <div></div>
                    </div>
                </div>
                <div class="app-content">
                    <div class="container-fluid">
                        <form id="userForm" class="needs-validation" novalidate th:action="@{/user/update/{id}(id=${user.id})}" th:object="${user}" method="post" enctype="multipart/form-data">
                            <div class="row">
                                <!-- Form User -->
                                <div class="col-md-8">
                                    <div class="card card-primary card-outline mb-4">
                                        <div class="card-header">
                                            <div class="card-title">User Form</div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="username" class="form-label">Username : <span class="text-danger">*</span></label>
                                                        <input type="text" id="username" name="username" th:value="${user.username}" class="form-control" placeholder="Username" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="password" class="form-label">Password : <span class="text-danger"></span></label>
                                                        <input type="password" id="password" name="password" class="form-control" placeholder="Password" />
                                                        <i style="font-size: 11px; color: black">*kosongkan password jika tidak ada perubahan</i>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="name" class="form-label">Nama Lengkap : <span class="text-danger">*</span></label>
                                                        <input type="text" id="name" name="name" th:value="${user.name}" class="form-control" placeholder="Nama Lengkap" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2 jk">
                                                        <label class="form-label">Jenis Kelamin: <span class="text-danger">*</span></label>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="jenis_kelamin" id="laki-laki" value="laki-laki" th:checked="${user.jenis_kelamin == 'laki-laki'}" />
                                                            <label class="form-check-label" for="laki-laki">Laki-laki</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" name="jenis_kelamin" id="perempuan" value="perempuan" th:checked="${user.jenis_kelamin == 'perempuan'}" />
                                                            <label class="form-check-label" for="perempuan">Perempuan</label>
                                                        </div>
                                                        <div class="invalid-feedback">Jenis Kelamin wajib diisi.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="email" class="form-label">Email :</label>
                                                        <input type="email" id="email" name="email" th:value="${user.email}" class="form-control" placeholder="example@example.com" />
                                                        <div class="invalid-feedback">Format email tidak valid.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="alamat" class="form-label">Alamat :</label>
                                                        <input type="text" id="alamat" name="alamat" th:value="${user.alamat}" class="form-control" placeholder="Jakarta" />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="no_ktp" class="form-label">No. KTP :</label>
                                                        <input type="text" id="no_ktp" name="no_ktp" th:value="${user.no_ktp}" class="form-control" placeholder="3576014403910003" />
                                                        <div class="invalid-feedback">No. KTP harus 16 digit angka.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="no_npwp" class="form-label">No. NPWP :</label>
                                                        <input type="text" id="no_npwp" name="no_npwp" th:value="${user.no_npwp}" class="form-control" placeholder="12.345.678.9-001.002" />
                                                        <div class="invalid-feedback">No. NPWP harus 15 digit angka.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="no_handphone" class="form-label">No. Handphone :</label>
                                                        <input type="tel" id="no_handphone" name="no_handphone" th:value="${user.no_handphone}" class="form-control" placeholder="082126377711" />
                                                        <div class="invalid-feedback">No. Handphone harus 8-15 digit angka.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label for="role" class="form-label">Role: <span class="text-danger">*</span></label>
                                                        <select class="form-select" id="role" name="role">
                                                            <option value="">Choose...</option>
                                                            <option value="1" th:selected="${user.role.id == 1}">Super Admin</option>
                                                            <option value="2" th:selected="${user.role.id == 2}">Admin</option>
                                                            <option value="3" th:selected="${user.role.id == 3}">User</option>
                                                        </select>
                                                        <div class="invalid-feedback">Role wajib dipilih.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Profile Picture -->
                                <div class="col-md-4">
                                    <div class="card card-primary card-outline mb-4">
                                        <div class="card-header">
                                            <div class="card-title">Profile Picture</div>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-center">
                                                <img th:src="${user.AvatarPath}" alt="" id="avatar" class="rounded" style="width: 250px; height: 250px" />
                                            </div>
                                            <div class="m-3">
                                                <label for="avatarUpload" class="form-label">Upload Picture :</label>
                                                <input type="file" id="avatarUpload" name="avatar" class="form-control" />
                                                <small id="error-message" style="color: red; display: none">Ukuran gambar maksimal 1MB!</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tombol Submit -->
                            <div class="col-md-12">
                                <div class="card mb-4">
                                    <div class="m-3 d-flex justify-content-between">
                                        <div>
                                            <a href="/user" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i>Back</a>
                                        </div>
                                        <div>
                                            <button class="btn btn-info" type="submit">Submit <i class="bi bi-arrow-right ms-2"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </main>

            <!-- =============================== Footer ================================ -->
            <div th:replace="fragments/footer  :: footer"></div>
        </div>
        <div th:replace="fragments/footer  :: script"></div>

        <!-- ================================= CSS ================================= -->
        <style>
            @media (min-width: 577px) and (max-width: 992px) {
                #avatar {
                    width: 150px !important;
                    height: 150px !important;
                }
            }
            .error {
                color: red;
            }
        </style>
        <!-- =============================== SCRIPT ================================ -->
        <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.js"></script>
        <script>
            $(function () {
                (rules = {
                    username: {
                        required: true,
                        specialChars: true,
                    },
                    password: {
                        required: false,
                    },
                    name: {
                        required: true,
                    },
                    jenis_kelamin: {
                        required: true,
                    },
                    email: {
                        email: true,
                    },
                    no_ktp: {
                        numericOnly: true,
                        minlength: 16,
                        maxlength: 16,
                    },
                    no_npwp: {
                        npwpFormat: true,
                    },
                    no_handphone: {
                        numericOnly: true,
                        minlength: 8,
                        maxlength: 12,
                    },
                    role: {
                        required: true,
                    },
                    avatar: {
                        fileType: true,
                        fileSize: true,
                    },
                }),
                    (messages = {
                        username: {
                            required: "Username wajib diisi",
                            specialChars: "Username hanya boleh huruf kecil dan angka",
                        },
                        password: {
                            required: "Password wajib diisi",
                        },
                        name: {
                            required: "Nama lengkap wajib diisi",
                        },
                        jenis_kelamin: {
                            required: "Jenis Kelamin wajib diisi",
                        },
                        email: {
                            email: "Masukan email yang valid",
                        },
                        no_ktp: {
                            numericOnly: "No KTP hanya boleh angka",
                            minlength: "Minimal 16 digit",
                            maxlength: "Maximal 16 digit",
                        },
                        no_npwp: {
                            npwpFormat: "Format NPWP tidak valid (XX.XXX.XXX.X-XXX.XXX)",
                        },
                        no_handphone: {
                            numericOnly: "No Handphone hanya boleh angka",
                            minlength: "Minimal 8 digit",
                            maxlength: "Maximal 12 digit",
                        },
                        role: {
                            required: "Role wajib diisi",
                        },
                    }),
                    (errorPlacement = function (error, element) {
                        if (element.is(":radio")) {
                            error.appendTo(element.parents(".jk"));
                        } else {
                            error.insertAfter(element);
                        }
                    });

                //Validasi Form
                $("#userForm").validate({
                    rules: rules,
                    messages: messages,
                    errorPlacement: errorPlacement,
                    submitHandler: function (form) {
                        iziToast.question({
                            timeout: false,
                            close: false,
                            color: "#0DCAF0",
                            overlay: true,
                            displayMode: "once",
                            id: "question",
                            zindex: 999,
                            title: "Hey",
                            message: "Apakah data sudah benar ?",
                            position: "center",
                            buttons: [
                                [
                                    "<button><b>YES</b></button>",
                                    function (instance, toast) {
                                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                                        form.submit();
                                    },
                                    true,
                                ],
                                [
                                    "<button>NO</button>",
                                    function (instance, toast) {
                                        instance.hide({ transitionOut: "fadeOut" }, toast, "button");
                                    },
                                ],
                            ],
                        });
                    },
                });

                //Huruf Kecil dan Angka Saja
                jQuery.validator.addMethod("specialChars", function (value, element) {
                    return this.optional(element) || /^[a-z 0-9]+$/.test(value);
                });

                //Number Only
                jQuery.validator.addMethod("numericOnly", function (value, element) {
                    return this.optional(element) || /^[0-9]+$/.test(value);
                });

                //Number and Special Charcter
                jQuery.validator.addMethod("npwpFormat", function (value, element) {
                    return this.optional(element) || /^\d{2}\.\d{3}\.\d{3}\.\d{1}\-\d{3}\.\d{3}$/.test(value);
                });

                //Validasi Tipe File
                jQuery.validator.addMethod("fileType", function (value, element) {
                    if (element.files.length > 0) {
                        var fileType = element.files[0].type;
                        return this.optional(element) || ["image/jpeg", "image/png", "image/jpg"].indexOf(fileType) !== -1;
                    }
                    return true;
                });

                //Validasi Ukuran File
                jQuery.validator.addMethod("fileSize", function (value, element) {
                    if (element.files.length > 0) {
                        var fileSize = element.files[0].size;
                        var maxSize = 1048576; // 1MB dalam bytes
                        return this.optional(element) || fileSize <= maxSize;
                    }
                    return true;
                });

                //Pesan Error File
                jQuery.validator.messages.fileType = "Format file harus jpg, jpeg, atau png!";
                jQuery.validator.messages.fileSize = "Ukuran gambar maksimal 1MB!";

                $("#avatarUpload").on("change", function () {
                    if (this.files && this.files[0]) {
                        var reader = new FileReader();
                        reader.onload = function (e) {
                            $("#avatar").attr("src", e.target.result);
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });

                var errorMessage = $("body").data("error"); // Ambil data sukses
                if (errorMessage) {
                    iziToast.error({
                        title: "Error",
                        position: "topCenter",
                        message: errorMessage,
                        transitionIn: "bounceInDown",
                        transitionOut: "fadeOutUp",
                    });
                    $("body").removeAttr("data-error");
                }
            });
        </script>
    </body>
</html>
